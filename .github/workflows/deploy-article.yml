name: Deploy Article

on:
  workflow_dispatch:
    inputs:
      filename:
        description: 'JSON-Dateiname'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Tools
        run: sudo apt-get update && sudo apt-get install -y curl jq

      - name: Download Article JSON from Supabase
        env:
          SUPABASE_URL: https://ngtujvgsbymtxphwncuj.supabase.co
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          mkdir -p work
          filename="${{ github.event.inputs.filename }}"
          echo "Downloading $filename ..."
          curl -s -H "Authorization: Bearer $SUPABASE_KEY" \
            "$SUPABASE_URL/storage/v1/object/articles/$filename" -o work/article.json
          if [ ! -s work/article.json ]; then
            echo "JSON fehlt oder leer. Abbruch."
            exit 1
          fi
          cat work/article.json | jq .

      - name: Build HTML from template
        run: |
          title=$(jq -r '.title // empty' work/article.json)
          id=$(jq -r '.id // empty' work/article.json)
          content=$(jq -r '.content // empty' work/article.json)
          datum=$(jq -r '.datum // empty' work/article.json)
          autor=$(jq -r '.author // empty' work/article.json)

          # Escape-Funktion, damit sed keine Sonderzeichen frisst
          escape_sed() {
            printf '%s' "$1" | sed -e 's/[\/&#]/\\&/g' -e 's/#/\\#/g'
          }

          esc_title=$(escape_sed "$title")
          esc_content=$(escape_sed "$content")
          esc_datum=$(escape_sed "$datum")
          esc_autor=$(escape_sed "$autor")

          slug=$(echo "$id" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g' | sed -E 's/^-|-$//g')
          filename="beitrag/${slug}.html"
          mkdir -p beitrag

          sed "s/{{TITLE}}/$esc_title/g; s/{{CONTENT}}/$esc_content/g; s/{{DATUM}}/$esc_datum/g; s/{{AUTOR}}/$esc_autor/g" template.html > "$filename"

          echo "HTML gebaut: $filename"

      - name: Commit & Push
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git add beitrag/
          git commit -m "Deploy article: $filename" || echo "Nothing to commit"
          git push
